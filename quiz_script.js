// ==========================================
// 1. å¬åŠ›åŸæ–‡æ•°æ® (TRANSCRIPTS - TPO 75)
// ==========================================
const TRANSCRIPTS = {
    'c1': `NARRATOR: Listen to a conversation between a student and the university public relations director.\n\nStudent: Donna Blake?\nDirector: Yes. Michael Jones?\nStudent: Great to see you. I'm so glad you're interested in helping our adult literacy program at the community center. We really need someone like you to promote our services.\nDirector: I don't know anything about that. The reason I asked you to come in today was to discuss the community achievement award you won for your volunteer work.\nStudent: That's what this is about. It's all connected anyhow.\nDirector: I'm sorry?\nStudent: The achievement award. I won it cause of all the volunteer hours I've put into the adult literacy program. I started it actually really.\nDirector: Really? Could you tell me more? It's for a news release. Whenever any of our students are faculty wins a national honor, it reflects well on our university. So I write a news release and send it to the media. This way, there's a good chance the city newspaper will pick up the story.\nStudent: Wow, cool. I've been quoted in the student newspaper, but the city paper that's different. It'll bring so much publicity to our program.\nDirector: You've earned your moment in the spotlight. In fact, you represent one of the best things about our school -- caring people. So let's get started. You said you founded the literacy program when?\nStudent: 3 years ago. I volunteered for an after school program at the local community center. It was fun. We were helping kids learn to read. Then one kid's Mom told me she also had trouble reading, so I thought maybe I could expand the program to teach literacy skills to adults, too. The director of the community center, he loved the idea. So now any adult can come in if they want to become better readers.\nDirector: So how'd you get chosen for the achievement award? Did you apply for it?\nStudent: No, the director nominated me. You can't nominate yourself, but the director submitted my name and all this Information about my volunteer work to the award committee.\nDirector: But you knew beforehand that you were nominated.\nStudent: No, I had no idea. Basically, I was shocked when I won. There were only like ten winners out of several hundred college students from around the country who were nominated.\nDirector: Very impressive. So how many people has your program served?\nStudent: We've tutored several hundred people so far.\nDirector: We?\nStudent: Yeah, I recruited like 12 volunteer tutors, friends, professor, I even got my family involved.\nDirector: Any plans for the prize money that comes with your award? Take a vacation, maybe?\nStudent: No, I'll use it for supplies for the literacy program, like workbooks and writing materials. Maybe now we can hire somebody to promote our program. We'd really like to bring in some more volunteers, so we can help more adult students.\nDirector: I think I've got enough for the release now. Listening to you...Maybe I can do some publicity for your center. I'll try to stop by soon to see if I can help.`,

    'l1': `NARRATOR: Listen to part of a lecture in an ancient history class.\n\nProfessor: That's your assignment for next week when we'll be finishing up our unit on the Sumerians. And we are going to get to that reading on the Hammurabi code in just a minute. But first, I wanna urge you to sign up for the museum trip. The art department is organizing. It's a great opportunity to see some of the Egyptian art we'll be reading about. In fact, many of the photos in your textbook are from the museums collection. If I if I can just ask you to indulge me for a moment, I want to talk about one of my favorite pieces from that collection, not just because it's a beautiful sculpture, but also because it's such a great example of how much a work of art can tell us about the society that produced it, which is especially important for studying ancient civilizations, where they're relatively few written documents and and what we called the material culture of a society, the physical objects, archaeologists uncover is a major type of evidence.\n\nOkay, so before I show you this slide, I need to fast forward to a period in Egyptian history, known as the New Kingdom. That's about 3,000 to 3,500 years ago about about 1,000 years after the great pyramids were built at Giza. Anyway, what I'm going to show you is this amazing statue of queen Hatshepsut. As we'll see later, Hatshepsut. It was one of a series of powerful pharaohs who brought Egypt in contact with other parts of the middle East and Africa.\n\nNow, Hatshepsut, it was not the first queen in Egypt. Usually queens were the wives of the pharaohs, the kings of Egypt, kings, the men were the ones who had power. Although when a pharaoh died and his son wasn't old enough to become king, the queen would act as his protector or so called regent ruling on behalf of the young heir. And that was true for Hatshepsut at first. She was regent protector for her nephew Thutmose III after the death of her husband. But soon after becoming regent, she did something quite remarkable. She adopted the title of pharaoh, a title which meant absolute power over Egypt.\n\nSo this was pretty amazing in the male dominated royal court to move beyond the role of regent to declare herself pharaoh. She clearly must have had the talent and skills to make such a bold move, because she seems to have gained the support of key officials.\n\nWhat did this remarkable ruler look like? Let's take a look at this slide to see how she had herself represented. Now, for the most part, Egyptian statues, especially statues of public figures, like kings, queens, and reigns, are highly stylized and symbolic. They're not supposed to show what a particular person looked like. Rather, they represented what the person stood for. In the case of pharaohs, first and foremost, a symbol of political power. So that here we see Hatshepsut are wearing the distinctive headcloth called the nemes, a symbol of royal authority. In fact, it probably looks familiar to you since pharaohs were always represented wearing the nemes. This was actually accurate because pharaohs did wear these headcloths in public.\n\nAnother feature common to pharaoh statues is the ceremonial beard. That's what you see here under Hatshepsut chin. The point is she didn't really have a beard nor did anyone think she did. But because it was the tradition for pharaohs to appear with such a beard, it became a purely ceremonial decoration.\n\nAnother interesting thing about this statue is the position of the hands. We'll be talking later about the religious role of pharaohs in Egyptian society. They were believed to act as intermediary between the Egyptian people and their gods, like a type of priest or spiritual go between her hands, rather than holding weapons or anything to represent military or political power. They emphasize this role.`,

    'l2': `NARRATOR: Listen to part of a lecture in a paleontology class.\n\nProfessor: So the best evidence we have suggests that earth is around 4.5 billion years old, right? So what we'd like to know as paleontologist studying the origin of life is how long after that did life begin on earth? Keith?\nMale Student: I think the book mentions of fossil, the oldest fossil ever found from like 3.5 billion years ago?\nProfessor: Good, that's right. That's the oldest fossil ever found that was left by what was clearly a living organism. Plus there's some older rocks that show traces of chemicals that are highly suggestive of life. But let's ignore that for now. It's been claimed that as much as 1 billion years passed between earth formation and the origin of life on this planet. But we have to consider, does this fossil evidence tell us conclusively when life began.\nMale Student: It can't really be conclusive. Can it? Because like, just because we haven't found any older fossils doesn't mean there weren't any right. I maybe we just haven't looked hard enough.\nProfessor: You're on the right track. The evidence we have certainly isn't conclusive, but you can't really say we haven't. Let me get back to that in just a second. First, think about this. Is it reasonable to expect it to take 1 billion years for life to evolve here?\nFemale Student: That depends on lots of other factors? Doesn't it? like, how long did it take for earth's temperature to cool down enough to support life?\nProfessor: A fair question. But if I may rephrase it slightly, what you really wanna know is how long was it before water could exist in liquid form? Let's just say that by the time earth's atmosphere had stabilized, and this was not long after the creation of the moon, say, 4.4 billion years ago. By this time, there were already substantial oceans covering the earth. We're still talking a 900 million year gap before that first fossil.\nMale Student: Well, I guess when you put it that way and it does seem like rather a long time.\nProfessor: So, but to get back to the point I was making before, we're not gonna resolve this question just by searching the world for older fossil records. Why? Before that oldest fossil we have from 3.5 billion years ago, before that, any kind of fossil record really had no chance of surviving. The process is going on within the earth during that time, the convection of molten rock within earth's mantle rising to the surface cooling and then sinking again, the volcanic activity, earthquakes all the things that led to the creation of plate tectonics, in fact, were so intense than any rocks pre dating that first fossil would have been crushed and very likely melted. So earth has, in face, erased its earliest history. There really are no early samples of earth left on earth.\nFemale Student: So, you mean, that's it. There's no way we can tell when life first appeared on earth?\nProfessor: Well there might be, let's think about this a minute. If no earlier rocks on earth could have survived with their fossil records intact. Is there anywhere else we could look?\nFemale Student: What you mean? Like an outer space or something?\nMale Student: No, wait, I think I see where she's going with this. Remember a few years ago when they found those media rights and like Antarctica or somewhere. And it turned out they actually came from Mars. So maybe the reverse could have happened, right? I if rocks from Mars could end up on earth, why couldn't there be earth rocks on Mars or even better on the moon.\nProfessor: Exactly. In fact, it's almost a certainty. We know that there were lots of meters in our region of the solar system during this time period. And quite a few of them hit the earth with a big enough impact, tons of earth rocks would have been tossed up into space. It's really not much of a leap to theorize that a good number of them might have ended up on the moon. In fact, researchers have calculated that there are probably thousands of tons of earth rocks on the moon just waiting to be found. If we could find, say, some 4.2 4.3 billion year old earth rock there, it happened to contain evidence of life. That would tell us something amazing, wouldn't it? Because that would mean that life on earth began quite quickly as soon as it possibly could have, which in turn would suggest that life is easily generated. And so it can probably be found all over the universe.`,

    'c2': `NARRATOR: Listen to a conversation between a student and her advisor.\n\nadvisor: Felicia, can you tell me why you haven't received a grade yet for your molecular biology course?\nstudent: Well, it's a long story, but my rp 73 experiment got messed up.\nadvisor: Wanna run that by me again, please?\nstudent: I'm sorry. I was running at a protein essay.\nadvisor: A protein essay?\nstudent: It's like an experiment to determine whether this rp 73 protein could have potential therapeutic value.\nadvisor: Like be applied in a medical context?\nstudent: That's the general idea of the hope anyway. But in order to do that, you first have to isolate the protein, produce it in a pure enough form for the experiment. And you have to produce enough of it also.\nadvisor: I think I'm starting to understand\nstudent: Well, when you're actually producing the protein that takes a long time, usually there's an overnight step where you need 16 hours in the incubator to what keep it at a warm enough temperature. And well, that's when things started to go downhill.\nadvisor: You didn't wait long enough?\nstudent: Actually, I waited too long. The protein got degraded, kind of disintegrated in there. I needed to come in to stop the incubation on Saturday, but it was one of those days. First, my car wouldn't start. I usually drive because the lab is kind of far, right? I tried taking the bus, but like I had no idea that there's hardly any buses on the weekend. Now I'm really panicking and I think I'll try to phone it in - call the lab and ask someone to take my experiment out of the incubator and stick it in the freezer. But no one's there because it's the weekend.\nadvisor: And was there no way to salvage the experiment?\nstudent: Mhm. It was like 1 o'clock when I finally made it to the lab. And by that time, the protein had degraded. It was basically unusable.\nadvisor: I see, but couldn't you just start over? And I did? Or normally, this kind of stuff happens in the lab all the time. And it's usually no big deal. But this experiment was too close to the end of the semester. Timing was too tight. I'm writing it again as we speak, but in the meantime, the semesters over and the greats had to be turned in. That's how I ended up with an Incomplete.\nstudent: Now, I understand. So you expect you'll be able to complete it soon. I'll probably need a couple more weeks. I spoke to my biology professor and she doesn't mind that I'm using the lab over the break. The lab never closes. There's always something going on.\nadvisor: Yes. I may be in the humanities, but I know enough about the sciences to know that much. I'll be expecting to receive a grade.`,

    'l3': `NARRATOR: Listen to part of a lecture in an acting class.\n\nProfessor: As you already know, from the course description, this class is going to teach you the fundamentals of acting. But before we get into any techniques and exercises, what you're going to be learning in here this semester is what's known as method acting. How many of you have heard of method acting? Almost all of you who can tell me what method acting is. Nobody. Donna, what's method acting?\nDonna: I'm not sure, but I think it was invented by a man named Stanislavski.\nProfessor: That's a start. Method acting is usually associated with a man named Stanislavski. Stanislavski loves he did not directly invent method acting. The story is he was bom in Russia in 1863. He developed a systematic approach to acting that became known as the Stanislavski system. Before Stanislavski acting meant forgetting about yourself and pretending to be someone else. And you pretended by using certain conventions. If an actor wanted to show this character want to revenge, he'd shake his fist and stomp his feet. Or if an actor wanted to show that her character was in love, she'd put her hands over her heart and so on. But Stanislavski developed a different approach, a psychological approach, where actors had to use their own personality, their own experiences and emotions when they were performing. And that principle became the basis for us now known as method acting. What happened was that starting back in the 1930s, acting teachers in the United States heard about the Stanislavski system, and they were very impressed by it, and so they adapted it and began teaching it in their own classes. And this modified version of the Stanislavski system became known as the method or method acting. Actually, there are quite a few varieties of method acting, but they're all based on Stanislavski's idea. Actors have to tap into their own experiences and emotions when they're performing. Donna?\nDonna: But what I what if that characters really different from me? II can't just stand up there and be myself, right?\nProfessor: No. You can't be Donna Smith from Kansas City, Missouri. But you can draw on certain parts of your personality, certain parts of your experience and emotional life. The key is you have to find parts of you, your life that are analogous to those of your character to your character s life.\nDonna: But let's say I'm playing a character who's like, really brave, like she's not afraid of anybody.\nProfessor: I'd be willing to bet that if you thought about it, you could think of a set of circumstances where you'd stand up and confront someone who is much more powerful than you. For example, suppose you had to do that to protect your family.\nDonna: But I'd be scared and my character wouldn't be.\nProfessor: Okay, let me tell you something. If you portray your character is not being afraid of anything, is going to be a very boring performance. What moves an audience is to see someone who scared to death stands up and does the right thing anyway. That's inspiring. It's that sort of complexity, the complexity of real people like you that's what brings a performance to life.\nDonna: Okay? But what if the script doesn't say that she's afraid? I you can just invent that yourself?\nProfessor: You can't just invent anything that pops into your head. But if it's consistent with the playwrights intentions, yes, you can certainly incorporate that.\nDonna: You mean, you can just change the words?\nProfessor: No, you can't change the words. What you're doing is filling in between the lines. Stanislavski once said something to the effect of people can read the lines at home. They come to the theater to hear what's between the lines.\nDonna: So you mean like the audience can see that the characters afraid by like her, her body language when she's not speaking?\nProfessor: Or even when she is speaking, something in her voice or her body language. When we say between the lines, we don't mean literally between one line of the script and another. We're talking about things that are not explicitly stated in the actors lines. For example, your character might say to another character "I hate you". But from the way you say it, your intonation and your body language, we know you're lying. So this semester, remember people can read the lines at home.`
};

// ==========================================
// 2. é¢˜åº“æ•°æ® (Quiz Data - TPO 75)
// ==========================================
const allQuizzes = {
    'c1': {
        title: "C1: Adult Literacy",
        audio: "audio/C1.mp3",
        questions: [
            { id: 1, type: "Gist", question: "1. Why does the woman wish to speak to the student?", options: ["A. To notify him about an award that he will be receiving", "B. To offer assistance with a program he runs", "C. To ask him to start a literacy program at the university", "D. To learn more about his accomplishments as a volunteer"], answer: [3] },
            { id: 2, type: "Attitude", question: "2. How does the student feel about the possibility of being mentioned in the city newspaper?", options: ["A. He is proud that he would be able to promote his university to the public at large", "B. He is excited that his literacy program would receive some publicity", "C. He is confused because he does not think readers of the city newspaper would be interested in his award.", "D. He is uncomfortable because he is one of several volunteers who deserve public recognition."], answer: [1] },
            { id: 3, type: "Detail", question: "3. How did the award committee become aware of the student?", options: ["A. The student submitted a description of his literacy program to the committee", "B. The director of the community center recommended him for an award.", "C. The committee received a news release describing the literacy program", "D. The student asked a committee member to volunteer for the literacy program."], answer: [1] },
            { id: 4, type: "Inference (Click 3)", question: "4. What can be inferred about the student? Click on 3 answers.", options: ["A. He works full time at the community center.", "B. He enjoys helping other people", "C. He is easily discouraged.", "D. He is persuasive.", "E. He is resourceful."], answer: [1, 3, 4] },
            { id: 5, type: "Replay", question: "5. Why does the woman say this:", audio: "audio/C1_reply.mp3", options: ["A. To apologize for not telling him the purpose of their meeting in advance", "B. To apologize for underestimating the extent of his volunteer work", "C. To ask him to clarify the meaning of his last statement", "D. To indicate that she disagrees with his last statement"], answer: [2] }
        ]
    },
    'l1': {
        title: "L1: Hatshepsut",
        audio: "audio/L1.mp3",
        questions: [
            { id: 1, type: "Gist (Click 2)", question: "1. What does the professor mainly discuss? (Click on 2 answers.)", options: ["A. A powerful and unusual ruler of Egypt", "B. Military actions during the New Kingdom period in Egypt", "C. How Hatshepsut's statue differs from those of other pharaohs", "D. What the features of a pharaoh's statue represent"], answer: [0, 3] },
            { id: 2, type: "Detail", question: "2. What does the professor imply about the 'material culture' of ancient societies?", options: ["A. It is considered more reliable than other types of evidence.", "B. It is the only source of information about certain societies.", "C. Most of it was created by unskilled workers.", "D. Its artistic value is greater than its historical value"], answer: [1] },
            { id: 3, type: "Detail", question: "3. What important distinction does the professor make between Hatshepsut and previous queens of Egypt?", options: ["A. She was the first queen to reign with the king", "B. She was the first queen to rule as regent-protector for a young heir", "C. She was the first queen to declare herself pharaoh.", "D. She was the first queen whose image appeared on public statues."], answer: [2] },
            { id: 4, type: "Inference", question: "4. What does the professor imply about the image of Hatshepsut wearing the nemes?", options: ["A. She wore the nemes to indicate her devotion to a particular deity", "B. She wore the nemes as a symbol of her royal power.", "C. She wore the nemes to indicate that she was female.", "D. She wore the nemes in public only rarely"], answer: [1] },
            { id: 5, type: "Detail", question: "5. According to the professor, what does Hatshepsut's hand gesture in the statue represent?", options: ["A. Hatshepsut's military strength", "B. Hatshepsut's absolute political authority", "C. Hatshepsut's spiritual role", "D. Hatshepsut's tolerance of different religions"], answer: [2] },
            { id: 6, type: "Function", question: "6. Why does the professor say this:", audio: null, options: ["A. To apologize for a mistake she just made", "B. To briefly clarify a statement she made at the beginning of the class", "C. To ask if the students have questions about the assigned reading", "D. To introduce a topic that is not related to the assigned reading"], answer: [3] }
        ]
    },
    'l2': {
        title: "L2: Origin of Life",
        audio: "audio/L2.mp3",
        questions: [
            { id: 1, type: "Gist", question: "1. What is the main purpose of the lecture?", options: ["A. To determine the age of the planet Earth", "B. To debate opposing theories of how life originated", "C. To consider ways to determine when life on Earth began", "D. To explain the process that formed the fossils found in ancient rocks"], answer: [2] },
            { id: 2, type: "Attitude", question: "2. What is the professor's attitude toward the claim that life first appeared on Earth around 3.5 billion years ago?", options: ["A. She is confident that the available evidence proves the claim conclusively", "B. She believes it is likely that living organisms existed long before that time", "C. She is concerned that the search for early fossils has not been thorough enough", "D. She doubts that fossilized rocks can always be dated accurately"], answer: [1] },
            { id: 3, type: "Function", question: "3. Why does the professor mention the violent processes that Earth underwent during its early history?", options: ["A. To explain how Earth acquired its current geological features", "B. To provide an alternative explanation of how life on Earth first began", "C. To show why it took so long for Earth to acquire a stable atmosphere", "D. To explain why it is unlikely that the earliest fossil specimens have survived"], answer: [3] },
            { id: 4, type: "Detail", question: "4. Why does the professor think paleontologists should study the Moon?", options: ["A. Its condition is similar to that of Earth 3.5 billion years ago", "B. It may contain Earth's most ancient surviving rocks.", "C. It is not affected by meteoric activity in the solar system", "D. It may provide clues to determine the age of fossils found in Antarctica"], answer: [1] },
            { id: 5, type: "Inference", question: "5. According to the professor if it is proven that life appeared soon after Earth was formed, what further conclusion might this fact support?", options: ["A. The universe is likely to contain many other Earth-like planets", "B. Living organisms are capable of surviving extreme conditions.", "C. Life probably exists in other parts of the universe", "D. Oceans may have covered Earth earlier than is commonly believed."], answer: [2] },
            { id: 6, type: "Inference", question: "6. What does the professor imply when she says this:", audio: null, options: ["A. Liquid water is the primary necessity for life to develop.", "B. Earth's temperature is not relevant to whether life can exist.", "C. Liquid water could have formed on other planets as well", "D. The student should consider a variety of conditions that support life."], answer: [0] }
        ]
    },
    'c2': {
        title: "C2: RP73 Experiment",
        audio: "audio/C2.mp3",
        questions: [
            { id: 1, type: "Gist", question: "1. What does the student try to explain to her adviser?", options: ["A. Why her experiment produced unexpected results", "B. Why she did not finish her experiment on time", "C. What properties of the RP73 protein she discovered", "D. Why she needs to have her grade changed"], answer: [1] },
            { id: 2, type: "Detail", question: "2. Why does the student want to study the RP73 protein?", options: ["A. Because it has an unusually rapid rate of disintegration", "B. Because it was only recently discovered", "C. Because it may have medical applications", "D. Because it may play a role in causing certain illnesses"], answer: [2] },
            { id: 3, type: "Detail", question: "3. According to the student, under what circumstance might her experiment have been saved?", options: ["A. If the lab incubator had been working properly", "B. If the experiment had not stayed in the freezer for so long", "C. If she had better understood the time needed for incubation", "D. If someone had been in the laboratory when she telephoned"], answer: [3] },
            { id: 4, type: "Inference", question: "4. From the student's comments, what can be inferred about the molecular biology professor?", options: ["A. The professor is disappointed that the student's experiment failed.", "B. The professor is used to students' having to repeat experiments.", "C. The professor would be willing to help the student redo the experiment", "D. The professor is likely to write a note to the adviser about what happened"], answer: [1] },
            { id: 5, type: "Replay", question: "5. Why does the adviser say this:", audio: "audio/C2_reply.mp3", options: ["A. He expects the student to receive an excellent grade in the class", "B. He is asking the student to work faster.", "C. He realizes that the student's experiment has now been completed.", "D. He feels assured that the student will fulfill her course requirements"], answer: [3] }
        ]
    },
    'l3': {
        title: "L3: Method Acting",
        audio: "audio/L3.mp3",
        questions: [
            { id: 1, type: "Gist", question: "1. What is the purpose of the lecture?", options: ["A. To help the students prepare for an examination", "B. To introduce students to the class they are taking", "C. To prepare the students for a play they are going to see", "D. To introduce students to a play they will be performing"], answer: [1] },
            { id: 2, type: "Detail", question: "2. What is the connection between Stanislavski and method acting?", options: ["A. He adapted method acting for the classroom.", "B. He was an early critic of method acting", "C. He was the first person to teach method acting in the United States", "D. He established the basic principles of method acting"], answer: [3] },
            { id: 3, type: "Detail", question: "3. Why does the professor mention an actor shaking his fist and stomping his feet?", options: ["A. To give an example of an outdated acting technique", "B. To give an example of an acting exercise from the Stanislavski System", "C. To illustrate that great actors always establish a strong emotional bond with their audience", "D. To illustrate that gestures can help actors feel real emotions on stage"], answer: [0] },
            { id: 4, type: "Detail", question: "4. According to the professor, what is the fundamental principle underlying all varieties of method acting?", options: ["A. Actors must develop their own system of gestures to use on stage.", "B. Actors must draw upon personal experience when playing a character", "C. Actors perform best when they do not consciously analyze the character they are playing", "D. Actors perform best when playing a character whose life experiences are similar to their own."], answer: [1] },
            { id: 5, type: "Replay", question: "5. What does the professor imply when he says this:", audio: "audio/L3_replay_q5.mp3", options: ["A. The student needs to think about what the writer intended", "B. The student needs to understand the character's circumstances.", "C. The student may be able to express a greater range of emotion than she realizes", "D. The student needs to speak with greater power when playing a brave character"], answer: [2] },
            { id: 6, type: "Replay", question: "6. What does the professor mean when he says this:", audio: "audio/L3_replay_q6.mp3", options: ["A. Students should read a play before seeing it performed.", "B. Students should memorize their lines before coming to class", "C. Actors should understand the meaning of their lines before memorizing them", "D. Actors should go beyond the literal meaning of the script."], answer: [3] }
        ]
    }
};

// ==========================================
// 3. å…¨å±€å˜é‡ä¸ DOM
// ==========================================
let currentQuizId = null;
let currentQuizData = null;
let currentStep = 0;
let userScore = 0;
let userHistory = [];
let currentSelectedIndices = [];
let timerInterval;
let secondsElapsed = 0;

const menuView = document.getElementById('menu-view');
const lectureView = document.getElementById('lecture-view');
const questionView = document.getElementById('question-view');
const resultView = document.getElementById('result-view');
const reviewView = document.getElementById('review-view');
const timerDisplay = document.getElementById('timer');

// ==========================================
// 4. é€»è¾‘æ§åˆ¶
// ==========================================

function startQuiz(quizId) {
    currentQuizId = quizId;
    currentQuizData = allQuizzes[quizId];
    currentStep = 0;
    userScore = 0;
    userHistory = [];
    currentSelectedIndices = [];
    secondsElapsed = 0;
    
    // UI åˆ‡æ¢
    menuView.style.display = 'none';
    lectureView.style.display = 'block';
    
    document.getElementById('page-title').textContent = currentQuizData.title;
    document.getElementById('lecture-title').textContent = "ğŸ§ " + currentQuizData.title;
    const mainAudio = document.getElementById('main-audio-player');
    mainAudio.src = currentQuizData.audio;
    
    // éšè—è®¡æ—¶å™¨
    timerDisplay.style.display = 'none';
    clearInterval(timerInterval);
    
    document.getElementById('start-questions-btn').onclick = startQuestions;
}

function startQuestions() {
    const mainAudio = document.getElementById('main-audio-player');
    mainAudio.pause();
    lectureView.style.display = 'none';
    questionView.style.display = 'block';

    // å¼€å§‹è®¡æ—¶
    timerDisplay.style.display = 'block';
    startTimer();

    loadQuestion(0);
}

function loadQuestion(index) {
    const qData = currentQuizData.questions[index];
    const isMulti = qData.answer.length > 1;
    
    document.getElementById('q-progress').textContent = `Question ${index + 1} of ${currentQuizData.questions.length}`;
    document.getElementById('q-type-tag').textContent = qData.type;

    const replayContainer = document.getElementById('replay-audio-container');
    const replayPlayer = document.getElementById('replay-player');
    if (qData.audio) {
        replayContainer.style.display = 'block';
        replayPlayer.src = qData.audio;
    } else {
        replayContainer.style.display = 'none';
        replayPlayer.pause();
    }

    document.getElementById('q-text').textContent = qData.question;

    const optionsContainer = document.getElementById('options-container');
    optionsContainer.innerHTML = '';
    currentSelectedIndices = [];
    document.getElementById('next-btn').disabled = true;

    qData.options.forEach((optText, i) => {
        const label = document.createElement('label');
        label.className = 'option-label';
        
        let displayText = optText;
        if (optText.match(/^[A-D]\.\s/)) {
            displayText = optText.substring(3);
        }

        label.innerHTML = `
            <span class="bubble">${String.fromCharCode(65 + i)}</span>
            <span class="option-text">${displayText}</span> 
        `;

        label.onclick = () => handleOptionClick(i, label, isMulti);
        optionsContainer.appendChild(label);
    });
}

function handleOptionClick(index, label, isMulti) {
    if (isMulti) {
        if (currentSelectedIndices.includes(index)) {
            currentSelectedIndices = currentSelectedIndices.filter(i => i !== index);
            label.classList.remove('selected');
        } else {
            currentSelectedIndices.push(index);
            label.classList.add('selected');
        }
        currentSelectedIndices.sort();
    } else {
        currentSelectedIndices = [index];
        document.querySelectorAll('.option-label').forEach(l => l.classList.remove('selected'));
        label.classList.add('selected');
    }
    document.getElementById('next-btn').disabled = currentSelectedIndices.length === 0;
}

document.getElementById('next-btn').onclick = () => {
    const qData = currentQuizData.questions[currentStep];
    const correctIndices = qData.answer;
    
    const isCorrect = JSON.stringify(currentSelectedIndices) === JSON.stringify(correctIndices);
    if (isCorrect) userScore++;

    userHistory.push({
        id: currentStep, 
        question: qData.question,
        options: qData.options,
        userIndices: [...currentSelectedIndices],
        correctIndices: correctIndices,
        isCorrect: isCorrect,
        audio: qData.audio || null
    });

    currentStep++;
    if (currentStep < currentQuizData.questions.length) {
        loadQuestion(currentStep);
    } else {
        showResults();
    }
};

function showResults() {
    questionView.style.display = 'none';
    resultView.style.display = 'block';
    
    clearInterval(timerInterval);
    
    document.getElementById('final-score').textContent = userScore;
    document.getElementById('total-questions').textContent = currentQuizData.questions.length;
}

// ==========================================
// 5. å¤ä¹ æ¨¡å¼ (æ ¸å¿ƒä¿®æ”¹ï¼šæ·»åŠ åŸæ–‡å½•éŸ³æ’­æ”¾å™¨)
// ==========================================
function enterReviewMode() {
    resultView.style.display = 'none';
    reviewView.style.display = 'block';
    
    // 1. ç”Ÿæˆé¡¶éƒ¨å¯¼èˆª
    const navBar = document.getElementById('question-navigator');
    navBar.innerHTML = '';
    
    userHistory.forEach((item, index) => {
        const btn = document.createElement('div');
        btn.className = `nav-num ${item.isCorrect ? 'correct' : 'wrong'}`;
        btn.textContent = index + 1;
        btn.onclick = () => renderReviewItem(index);
        navBar.appendChild(btn);
    });

    // 2. å¡«å……å¬åŠ›åŸæ–‡å’Œæ’­æ”¾å™¨ (ä¿®æ”¹å¤„)
    const rightPanel = document.querySelector('.right-panel');
    rightPanel.innerHTML = `
        <div class="tab-header">
            <span class="active-tab">æŸ¥çœ‹åŸæ–‡ & å¬å½•éŸ³</span>
        </div>
        <div style="padding: 15px; border-bottom: 1px solid #eee; background: #f9f9f9;">
            <audio controls src="${currentQuizData.audio}" style="width: 100%; height: 35px;"></audio>
        </div>
        <div class="transcript-content" id="transcript-text">
            ${TRANSCRIPTS[currentQuizId] || "Transcript not available."}
        </div>
    `;

    // 3. é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€é¢˜
    renderReviewItem(0);
}

function renderReviewItem(index) {
    document.querySelectorAll('.nav-num').forEach((btn, i) => {
        if(i === index) btn.classList.add('active');
        else btn.classList.remove('active');
    });

    const data = userHistory[index];
    const qContainer = document.getElementById('review-q-content');
    
    let html = '';

    if (data.audio) {
        html += `
            <div class="review-replay-block">
                <span class="replay-label">ğŸ”Š é‡å¬ç‰‡æ®µ (Replay Audio)</span>
                <audio controls src="${data.audio}" class="review-audio"></audio>
            </div>
        `;
    }

    html += `<div class="review-q-text">${data.question}</div>`;
    
    data.options.forEach((opt, i) => {
        let text = opt;
        if (opt.match(/^[A-D]\.\s/)) text = opt.substring(3);
        const char = String.fromCharCode(65 + i);
        
        html += `<div class="review-option">
            <span class="opt-char">${char}.</span>
            <span class="opt-text">${text}</span>
        </div>`;
    });
    
    qContainer.innerHTML = html;

    const ansBar = document.getElementById('review-answer-bar');
    const myAnsStr = data.userIndices.map(i => String.fromCharCode(65+i)).join("");
    const corAnsStr = data.correctIndices.map(i => String.fromCharCode(65+i)).join("");
    
    const myColorClass = data.isCorrect ? "ans-green" : "ans-red";
    
    ansBar.innerHTML = `
        <span class="ans-label ${myColorClass}">æˆ‘çš„ç­”æ¡ˆ ${myAnsStr}</span>
        <span class="ans-label ans-green">æ­£ç¡®ç­”æ¡ˆ ${corAnsStr}</span>
    `;
}

// ==========================================
// 6. è¾…åŠ©åŠŸèƒ½
// ==========================================
function startTimer() {
    secondsElapsed = 0;
    timerDisplay.textContent = "Time: 00:00";
    
    timerInterval = setInterval(() => {
        secondsElapsed++;
        const m = Math.floor(secondsElapsed / 60).toString().padStart(2, '0');
        const s = (secondsElapsed % 60).toString().padStart(2, '0');
        timerDisplay.textContent = `Time: ${m}:${s}`;
    }, 1000);
}

function backToMenu() {
    document.querySelectorAll('audio').forEach(a => a.pause());
    
    lectureView.style.display = 'none';
    questionView.style.display = 'none';
    resultView.style.display = 'none';
    reviewView.style.display = 'none';
    timerDisplay.style.display = 'none';
    
    menuView.style.display = 'block';
    document.getElementById('page-title').textContent = "TPO 75 Practice";
}